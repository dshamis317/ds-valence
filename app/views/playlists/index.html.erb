<h2>Hi, <%= @user.email %>. Welcome to Valence</h2>

<h4>You currently have <%= @user.playlists.count%> playlists.
  <% if @user.playlists.count.zero? %>
  <a class="open" href="">Would you like to create one?</a>
  <% else %>
  <a class="open" href="">Create Another?</a>
  <% end %>
</h4>

<div class="edit-form" style="display: none">

  <form action="/users/<%= current_user.id %>/playlists/" method='post'>
    <%= token_tag %>
    <p>title<input class='field' type="text" name='playlist[title]'></input></p>
    <p>mood<input class='field' type="text" name='playlist[mood]'></input></p>
    <p>
      <button type="submit" class="go-away">Create Playlist</button>
      <button type="reset">Reset</button>
      <input type="button" value="cancel" class="go-away"></input>
    </p>
  </form>
</div>

<script>
$( ".open" ).click(function(e) {
  e.preventDefault();
  $( ".edit-form" ).show( "slow" );
});
$( ".go-away" ).click(function() {
  $( ".edit-form" ).hide( "slow" );
});
</script>

<form action="/search" method="get" class="song-search">
  <label for="">Song Search: </label>
  <input type="text" name="name" placeholder="Song" class="song-text-field">
  <input type="submit" value="Search" class="song-search-submit"></input>
</form>

<ul>
  <% @playlists.each do |playlist| %>
  <div class="playlist-index <%= playlist.id %>" data-user-id="<%= current_user.id %>" data-playlist-id="<%= playlist.id %>">
    <li>
      <a href="/users/<%= current_user.id %>/playlists/<%= playlist.id %>"><%= playlist.title %></a>
      <p>Mood: <%= playlist.mood %></p>

      <div class="playlist-songs-index"></div>
      <form action="/users/<%= current_user.id %>/playlists/<%= playlist.id %>" method='post'>
        <%= token_tag %>
        <input type="hidden" name='_method' value='delete'>
        <button type='submit'><i class="fa fa-trash-o fa-2x"></i></button>
      </form>
    </li>
  </div>
  <% end %>
</ul>

<img src="<%= asset_path 'drums.gif' %>" alt="" class="spinner">

<div class="search-results">
</div>

<!-- <ul class="sortable">
  <li class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>This is a test 1</li>
  <li class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>This is a test 2</li>
  <li class="ui-state-default"><span class="ui-icon ui-icon-arrowthick-2-n-s"></span>This is a test 3</li>
</ul> -->

<script>

var songCollection = new SongCollection();


function setDroppableHandlers() {
  $('.playlist-index').droppable({
    drop: function(e, dropped) {
      var index = dropped.draggable.data('index');
      shrinkArtwork(dropped.draggable);
      var playlistID = parseInt(e.target.attributes[2].value)
      addSongToDatabase(playlistID, index);
    }
  })
}

function shrinkArtwork(el) {
  el.toggle('scale');
}

function addSongToDatabase(playlistID, index) {
  var resultsArray = songCollection.searchResults;
  songCollection.addToDB(playlistID, resultsArray[index]);
}

$(function() {
  $('.song-search').submit(function(e) {
    // $('.search-results').html('');
    e.preventDefault();
    var query = $('.song-text-field').val();
    songCollection.search(query);
  })

  $(document).ajaxStart(function() {
    console.log('BOOM')
    $('.spinner').show();
  }).ajaxStop(function() {
    console.log('STOP')
    $('.spinner').hide();
  }).ajaxError(function() {
    $('.spinner').hide();
  });

  setDroppableHandlers();
})

</script>



